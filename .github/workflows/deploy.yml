name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup environment and build
        env:
          GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
          CF_BEACON_TOKEN: ${{ secrets.CF_BEACON_TOKEN }}
          WEB3FORMS_ACCESS_KEY: ${{ secrets.WEB3FORMS_ACCESS_KEY }}
        run: |
          echo "ðŸš€ Building with GitHub Secrets..."
          
          # Create config.js with environment variables from GitHub Secrets
          cat > assets/js/config.js << EOF
          // Configuration loaded from GitHub Secrets
          // Auto-generated by GitHub Actions - DO NOT EDIT DIRECTLY
          window.APP_CONFIG = {
            // Google Analytics
            GA_MEASUREMENT_ID: '${{ secrets.GA_MEASUREMENT_ID }}',
            
            // Cloudflare Web Analytics  
            CF_BEACON_TOKEN: '${{ secrets.CF_BEACON_TOKEN }}',
            
            // Web3Forms
            WEB3FORMS_ACCESS_KEY: '${{ secrets.WEB3FORMS_ACCESS_KEY }}'
          };
          EOF
          
          # Process HTML files to inject analytics scripts
          for file in *.html; do
            echo "Processing \$file..."
            
            # Create temporary file
            temp_file="\${file}.tmp"
            
            # Replace placeholders in HTML files
            sed -e "s/GA_MEASUREMENT_ID/${{ secrets.GA_MEASUREMENT_ID }}/g" \\
                -e "s/CF_BEACON_TOKEN/${{ secrets.CF_BEACON_TOKEN }}/g" \\
                -e "s/WEB3FORMS_ACCESS_KEY/${{ secrets.WEB3FORMS_ACCESS_KEY }}/g" \\
                "\$file" > "\$temp_file"
            
            mv "\$temp_file" "\$file"
          done
          
          echo "âœ… Build complete with secrets applied!"

      - name: Deploy to Cloudflare Pages
        run: |
          echo "Cloudflare Pages will automatically deploy this push"
          echo "Deployment URL: https://www.pillsnap.co.kr"
