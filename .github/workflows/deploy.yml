name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup environment and build
        run: |
          echo "ğŸš€ Building with GitHub Secrets..."
          
          # Create config.js with environment variables from GitHub Secrets
          cat > assets/js/config.js << 'EOF'
          // Configuration loaded from GitHub Secrets
          // Auto-generated by GitHub Actions - DO NOT EDIT DIRECTLY
          window.APP_CONFIG = {
            // Google Analytics
            GA_MEASUREMENT_ID: 'GA_ID_PLACEHOLDER',
            
            // Cloudflare Web Analytics  
            CF_BEACON_TOKEN: 'CF_TOKEN_PLACEHOLDER',
            
            // Web3Forms
            WEB3FORMS_ACCESS_KEY: 'WEB3_KEY_PLACEHOLDER'
          };
          EOF
          
          # Replace placeholders with actual values
          sed -i "s/GA_ID_PLACEHOLDER/${{ secrets.GA_MEASUREMENT_ID }}/g" assets/js/config.js
          sed -i "s/CF_TOKEN_PLACEHOLDER/${{ secrets.CF_BEACON_TOKEN }}/g" assets/js/config.js
          sed -i "s/WEB3_KEY_PLACEHOLDER/${{ secrets.WEB3FORMS_ACCESS_KEY }}/g" assets/js/config.js
          
          # Process HTML files
          sed -i "s/GA_MEASUREMENT_ID/${{ secrets.GA_MEASUREMENT_ID }}/g" *.html
          sed -i "s/CF_BEACON_TOKEN/${{ secrets.CF_BEACON_TOKEN }}/g" *.html
          sed -i "s/WEB3FORMS_ACCESS_KEY/${{ secrets.WEB3FORMS_ACCESS_KEY }}/g" *.html
          
          echo "âœ… Build complete with secrets applied!"

      - name: Deploy to Cloudflare Pages
        run: |
          echo "Cloudflare Pages will automatically deploy this push"
          echo "Deployment URL: https://www.pillsnap.co.kr"
